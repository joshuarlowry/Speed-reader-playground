<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Offline-first RSVP speed reader for txt, markdown, PDF, and EPUB files">
  <title>Speed Reader</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="stylesheet" href="/src/styles.css">
  <style>
    /* Fallback styles to ensure visibility */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #app {
      height: 100%;
      width: 100%;
    }
    #upload-area {
      display: flex !important;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: #0a0a0a;
      color: #e8e8e8;
    }
    #upload-area.hidden {
      display: none !important;
    }
  </style>
</head>
<body class="h-full overflow-hidden">
  <div id="app" class="h-full w-full">
    <!-- Main reader view -->
    <div id="reader-view" class="reader-view hidden">
      <div id="scope-indicator" class="scope-indicator hidden"></div>
      <div id="word-container" class="word-container">
        <span id="word-display" class="word-display"></span>
      </div>
    </div>

    <!-- Controls overlay -->
    <div id="controls-overlay" class="controls-overlay hidden">
      <div class="controls-content">
        <div class="controls-row">
          <button id="btn-rewind" class="btn btn-icon" aria-label="Rewind 10 words">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="11 17 6 12 11 7"></polyline>
              <polyline points="18 17 13 12 18 7"></polyline>
            </svg>
          </button>
          <button id="btn-play-pause" class="btn btn-play" aria-label="Play/Pause">
            <svg id="icon-play" width="28" height="28" viewBox="0 0 24 24" fill="currentColor" class="ml-0.5">
              <path d="M8 5v14l11-7z"/>
            </svg>
            <svg id="icon-pause" class="hidden" width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
              <rect x="6" y="4" width="4" height="16"></rect>
              <rect x="14" y="4" width="4" height="16"></rect>
            </svg>
          </button>
          <button id="btn-forward" class="btn btn-icon" aria-label="Forward 10 words">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="13 17 18 12 13 7"></polyline>
              <polyline points="6 17 11 12 6 7"></polyline>
            </svg>
          </button>
          <button id="btn-settings" class="btn btn-icon" aria-label="Settings">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"></path>
            </svg>
          </button>
        </div>
        <div class="progress-row">
          <input type="range" id="progress-scrubber" class="progress-scrubber" min="0" max="100" value="0" aria-label="Reading progress">
        </div>
      </div>
    </div>

    <!-- Settings modal -->
    <div id="settings-modal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Settings</h2>
          <button id="btn-close-settings" class="btn-close" aria-label="Close settings">×</button>
        </div>
        <div class="modal-body">
          <div class="setting-group">
            <label for="wpm-slider" class="flex items-center justify-between mb-3">
              <span>Words per minute</span>
              <span id="wpm-value" class="text-accent font-semibold">300</span>
            </label>
            <input type="range" id="wpm-slider" min="100" max="1000" value="300" step="10" class="w-full">
          </div>
          <div class="setting-group">
            <button id="btn-contents" class="btn btn-secondary w-full">Contents</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Contents drawer -->
    <div id="contents-drawer" class="drawer hidden">
      <div class="drawer-header">
        <h2>Contents</h2>
        <button id="btn-close-contents" class="btn-close" aria-label="Close contents">×</button>
      </div>
      <div id="contents-list" class="contents-list"></div>
    </div>

    <!-- Resume modal -->
    <div id="resume-modal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Resume Reading</h2>
        </div>
        <div class="modal-body">
          <p id="resume-preview" class="text-muted-foreground mb-6 leading-relaxed"></p>
          <div class="modal-actions">
            <button id="btn-resume" class="btn btn-primary w-full">Resume where you left off</button>
            <button id="btn-start-over" class="btn btn-secondary w-full">Start over</button>
            <button id="btn-choose-bookmark" class="btn btn-ghost w-full">Choose bookmark</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Scope end modal -->
    <div id="scope-end-modal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-body text-center py-8">
          <p class="text-lg mb-6 text-muted-foreground">End of section</p>
          <div class="modal-actions">
            <button id="btn-replay-scope" class="btn btn-primary w-full">Replay</button>
            <button id="btn-next-section" class="btn btn-secondary w-full">Next section</button>
            <button id="btn-clear-scope" class="btn btn-ghost w-full">Clear scope</button>
          </div>
        </div>
      </div>
    </div>

    <!-- File upload area (initial state) -->
    <div id="upload-area" class="upload-area">
      <div class="upload-content">
        <div class="mb-8">
          <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="upload-icon">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
        </div>
        <h1>Speed Reader</h1>
        <p>Upload a document to begin reading</p>
        <div class="flex flex-col sm:flex-row gap-4 mt-8">
          <input type="file" id="file-input" accept=".txt,.md,.pdf,.epub" aria-label="Upload document" class="hidden">
          <label for="file-input" class="btn btn-primary cursor-pointer">Choose File</label>
          <button id="btn-load-demo" class="btn btn-secondary">Load Demo</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Error display (shown if app fails to load) -->
  <div id="error-display" class="hidden fixed inset-0 z-[9999] flex items-center justify-center bg-background p-4">
    <div class="max-w-2xl w-full bg-card border border-destructive rounded-lg p-6 shadow-2xl">
      <h2 class="text-2xl font-bold text-destructive mb-4">Application Error</h2>
      <pre id="error-message" class="text-sm text-foreground bg-muted p-4 rounded overflow-auto max-h-[60vh] whitespace-pre-wrap font-mono"></pre>
      <div class="mt-4 flex gap-3">
        <button onclick="location.reload()" class="btn btn-primary">Reload Page</button>
        <button onclick="document.getElementById('error-display').classList.add('hidden')" class="btn btn-secondary">Dismiss</button>
      </div>
    </div>
  </div>

  <script>
    // Global error handler - displays errors on page
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error);
      const errorDisplay = document.getElementById('error-display');
      const errorMessage = document.getElementById('error-message');
      if (errorDisplay && errorMessage) {
        const errorText = event.error 
          ? `${event.error.name}: ${event.error.message}\n\n${event.error.stack || 'No stack trace'}`
          : `${event.message} at ${event.filename}:${event.lineno}:${event.colno}`;
        errorMessage.textContent = errorText;
        errorDisplay.classList.remove('hidden');
      }
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection:', event.reason);
      const errorDisplay = document.getElementById('error-display');
      const errorMessage = document.getElementById('error-message');
      if (errorDisplay && errorMessage) {
        const errorText = event.reason instanceof Error
          ? `Unhandled Promise Rejection: ${event.reason.name}: ${event.reason.message}\n\n${event.reason.stack || 'No stack trace'}`
          : `Unhandled Promise Rejection: ${String(event.reason)}`;
        errorMessage.textContent = errorText;
        errorDisplay.classList.remove('hidden');
      }
    });

    // Check if app loaded after 3 seconds
    setTimeout(() => {
      const app = document.getElementById('app');
      const uploadArea = document.getElementById('upload-area');
      if (app && (!uploadArea || uploadArea.classList.contains('hidden')) && !document.getElementById('reader-view')?.classList.contains('hidden')) {
        // App might not have initialized - check for errors
        const errorDisplay = document.getElementById('error-display');
        if (errorDisplay && errorDisplay.classList.contains('hidden')) {
          // No error shown but app seems stuck - show a warning
          console.warn('App may not have initialized properly');
        }
      }
    }, 3000);
  </script>

  <script type="module" src="/src/main.js"></script>
  <script type="module">
    // Service worker registration with error handling
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        try {
          const basePath = import.meta.env.BASE_URL || '/';
          navigator.serviceWorker.register(basePath + 'sw.js')
            .catch(err => {
              console.log('SW registration failed:', err);
              // Don't show this as a critical error - app can work without SW
            });
        } catch (err) {
          console.error('SW registration error:', err);
        }
      });
    }
  </script>
</body>
</html>
