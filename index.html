<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Offline-first RSVP speed reader for txt, markdown, PDF, and EPUB files">
  <meta name="theme-color" content="#0a0a0a">
  <title>Speed Reader</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="stylesheet" href="/src/styles.css">
  <style>
    /* Fallback styles to ensure visibility */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #app {
      height: 100%;
      width: 100%;
    }
    #upload-area {
      display: flex !important;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: #0a0a0a;
      color: #e8e8e8;
    }
    #upload-area.hidden {
      display: none !important;
    }
  </style>
</head>
<body class="h-full">
  <!-- Skip link for keyboard users -->
  <a href="#main-content" class="skip-link">Skip to main content</a>
  
  <div id="app" class="h-full w-full">
    <!-- Main reader view -->
    <main id="reader-view" class="reader-view hidden" aria-label="Reading area">
      <div id="scope-indicator" class="scope-indicator hidden" role="status" aria-live="polite"></div>
      <div id="word-container" class="word-container" role="region" aria-label="Current word display">
        <span id="word-display" class="word-display" aria-live="off" aria-atomic="true"></span>
        <!-- Hidden live region for screen reader announcements -->
        <div id="sr-announcer" class="sr-only" aria-live="polite" aria-atomic="true"></div>
      </div>
      
      <!-- Book menu (upper right) -->
      <nav id="book-menu" class="book-menu" aria-label="Book options">
        <button id="btn-book-menu" class="btn-book-menu" aria-label="Book menu" aria-expanded="false" aria-haspopup="menu">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
          </svg>
        </button>
        <div id="book-menu-dropdown" class="book-menu-dropdown hidden" role="menu" aria-label="Book menu options">
          <button id="btn-close-book" class="book-menu-item" role="menuitem">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M18 6L6 18"></path>
              <path d="M6 6l12 12"></path>
            </svg>
            <span>Close Book</span>
          </button>
        </div>
      </nav>
    </main>

    <!-- Controls overlay (hidden until a book is loaded) -->
    <div id="controls-overlay" class="controls-overlay hidden" role="toolbar" aria-label="Reading controls">
      <div class="controls-content">
        <div class="progress-row">
          <input type="range" id="progress-scrubber" class="progress-scrubber" min="0" max="100" value="0" aria-label="Reading progress" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-valuetext="0% complete">
        </div>
        <div class="controls-row">
          <button id="btn-contents-quick" class="btn btn-icon" aria-label="Open table of contents">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <line x1="8" y1="6" x2="21" y2="6"></line>
              <line x1="8" y1="12" x2="21" y2="12"></line>
              <line x1="8" y1="18" x2="21" y2="18"></line>
              <line x1="3" y1="6" x2="3.01" y2="6"></line>
              <line x1="3" y1="12" x2="3.01" y2="12"></line>
              <line x1="3" y1="18" x2="3.01" y2="18"></line>
            </svg>
          </button>
          <span class="controls-separator" aria-hidden="true">|</span>
          <button id="btn-prev-section" class="btn btn-icon" aria-label="Go to previous section">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <polyline points="11 17 6 12 11 7"></polyline>
              <line x1="6" y1="12" x2="18" y2="12"></line>
            </svg>
          </button>
          <button id="btn-rewind" class="btn btn-icon" aria-label="Rewind 5 seconds">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <polyline points="11 17 6 12 11 7"></polyline>
              <polyline points="18 17 13 12 18 7"></polyline>
            </svg>
          </button>
          <button id="btn-play-pause" class="btn btn-play" aria-label="Play" aria-pressed="false">
            <svg id="icon-play" width="28" height="28" viewBox="0 0 24 24" fill="currentColor" class="ml-0.5" aria-hidden="true">
              <path d="M8 5v14l11-7z"/>
            </svg>
            <svg id="icon-pause" class="hidden" width="28" height="28" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <rect x="6" y="4" width="4" height="16"></rect>
              <rect x="14" y="4" width="4" height="16"></rect>
            </svg>
          </button>
          <button id="btn-forward" class="btn btn-icon" aria-label="Forward 5 seconds">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <polyline points="13 17 18 12 13 7"></polyline>
              <polyline points="6 17 11 12 6 7"></polyline>
            </svg>
          </button>
          <button id="btn-next-section-controls" class="btn btn-icon" aria-label="Go to next section">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <polyline points="13 17 18 12 13 7"></polyline>
              <line x1="18" y1="12" x2="6" y2="12"></line>
            </svg>
          </button>
          <span class="controls-separator" aria-hidden="true">|</span>
          <button id="btn-speed-down" class="btn btn-icon" aria-label="Decrease reading speed">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="8" y1="12" x2="16" y2="12"></line>
            </svg>
          </button>
          <div class="speed-indicator" role="status" aria-live="polite">
            <span id="wpm-display" class="wpm-display">500</span>
            <span class="wpm-label">WPM</span>
          </div>
          <button id="btn-speed-up" class="btn btn-icon" aria-label="Increase reading speed">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="16"></line>
              <line x1="8" y1="12" x2="16" y2="12"></line>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Settings modal (kept for advanced settings if needed) -->
    <div id="settings-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="settings-title">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="settings-title">Settings</h2>
          <button id="btn-close-settings" class="btn-close" aria-label="Close settings">×</button>
        </div>
        <div class="modal-body">
          <div class="setting-group">
            <label for="wpm-slider" class="flex items-center justify-between mb-3">
              <span>Words per minute</span>
              <span id="wpm-value" class="text-accent font-semibold" aria-live="polite">300</span>
            </label>
            <input type="range" id="wpm-slider" min="100" max="1000" value="500" step="10" class="w-full" aria-valuemin="100" aria-valuemax="1000" aria-valuenow="500">
          </div>
        </div>
      </div>
    </div>

    <!-- Contents drawer -->
    <aside id="contents-drawer" class="drawer hidden" role="dialog" aria-modal="true" aria-labelledby="contents-title">
      <div class="drawer-header">
        <h2 id="contents-title">Contents</h2>
        <button id="btn-close-contents" class="btn-close" aria-label="Close table of contents">×</button>
      </div>
      <nav id="contents-list" class="contents-list" aria-label="Table of contents" role="list"></nav>
    </aside>

    <!-- Resume modal -->
    <div id="resume-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="resume-title" aria-describedby="resume-preview">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="resume-title">Resume Reading</h2>
        </div>
        <div class="modal-body">
          <p id="resume-preview" class="text-muted-foreground mb-6 leading-relaxed"></p>
          <div class="modal-actions" role="group" aria-label="Resume options">
            <button id="btn-resume" class="btn btn-primary w-full">Resume where you left off</button>
            <button id="btn-start-over" class="btn btn-secondary w-full">Start over</button>
            <button id="btn-choose-bookmark" class="btn btn-ghost w-full">Choose bookmark</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Scope end modal -->
    <div id="scope-end-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="scope-end-title">
      <div class="modal-content">
        <div class="modal-body text-center py-8">
          <p id="scope-end-title" class="text-lg mb-6 text-muted-foreground">End of section</p>
          <div class="modal-actions" role="group" aria-label="Section complete options">
            <button id="btn-replay-scope" class="btn btn-primary w-full">Replay section</button>
            <button id="btn-next-section-modal" class="btn btn-secondary w-full">Go to next section</button>
            <button id="btn-clear-scope" class="btn btn-ghost w-full">Clear scope and continue</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Speed selection modal -->
    <div id="speed-select-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="speed-select-title" aria-describedby="speed-select-desc">
      <div class="modal-content speed-select-content">
        <div class="modal-header">
          <h2 id="speed-select-title">Choose Your Reading Speed</h2>
        </div>
        <div class="modal-body">
          <p id="speed-select-desc" class="text-muted-foreground text-center mb-6">Select a starting speed (you can adjust anytime)</p>
          <div class="speed-options" role="radiogroup" aria-label="Reading speed options">
            <button class="speed-option" data-wpm="150" role="radio" aria-checked="false" aria-label="150 words per minute, Relaxed pace">
              <span class="speed-value" aria-hidden="true">150</span>
              <span class="speed-label" aria-hidden="true">Relaxed</span>
            </button>
            <button class="speed-option" data-wpm="300" role="radio" aria-checked="false" aria-label="300 words per minute, Easy pace">
              <span class="speed-value" aria-hidden="true">300</span>
              <span class="speed-label" aria-hidden="true">Easy</span>
            </button>
            <button class="speed-option speed-option-featured" data-wpm="500" role="radio" aria-checked="false" aria-label="500 words per minute, Standard pace, recommended">
              <span class="speed-value" aria-hidden="true">500</span>
              <span class="speed-label" aria-hidden="true">Standard</span>
            </button>
            <button class="speed-option" data-wpm="700" role="radio" aria-checked="false" aria-label="700 words per minute, Fast pace">
              <span class="speed-value" aria-hidden="true">700</span>
              <span class="speed-label" aria-hidden="true">Fast</span>
            </button>
            <button class="speed-option" data-wpm="900" role="radio" aria-checked="false" aria-label="900 words per minute, Ludicrous pace">
              <span class="speed-value" aria-hidden="true">900</span>
              <span class="speed-label" aria-hidden="true">Ludicrous</span>
            </button>
          </div>
          <p class="text-muted-foreground text-xs text-center mt-6" aria-hidden="true">Words per minute</p>
        </div>
      </div>
    </div>

    <!-- File upload area (initial state) -->
    <div id="upload-area" class="upload-area" id="main-content">
      <div class="upload-content-wrapper">
        <header class="upload-header">
          <h1>Speed Reader</h1>
          <p>Upload a document or try a sample book</p>
          <div class="upload-actions">
            <input type="file" id="file-input" accept=".txt,.md,.pdf,.epub" class="hidden">
            <label for="file-input" class="btn btn-primary cursor-pointer" role="button" tabindex="0">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
              <span>Upload File</span>
            </label>
          </div>
        </header>
        
        <section class="sample-books-section" aria-labelledby="sample-books-heading">
          <h2 id="sample-books-heading">Sample Books</h2>
          <div class="sample-books-grid" role="list">
            <button class="book-card" data-book="pride-and-prejudice" role="listitem" aria-label="Open Pride and Prejudice by Jane Austen">
              <div class="book-cover">
                <img src="./books/pride-and-prejudice-cover.avif" alt="" loading="lazy" aria-hidden="true">
              </div>
              <div class="book-info">
                <span class="book-title">Pride and Prejudice</span>
                <span class="book-author">Jane Austen</span>
              </div>
            </button>
            <button class="book-card" data-book="brooklyn-murders" role="listitem" aria-label="Open The Brooklyn Murders by G.D.H. Cole">
              <div class="book-cover">
                <img src="./books/brooklyn-murders-cover.avif" alt="" loading="lazy" aria-hidden="true">
              </div>
              <div class="book-info">
                <span class="book-title">The Brooklyn Murders</span>
                <span class="book-author">G.D.H. Cole</span>
              </div>
            </button>
            <button class="book-card" data-book="princess-and-the-goblin" role="listitem" aria-label="Open The Princess and the Goblin by George MacDonald">
              <div class="book-cover">
                <img src="./books/princess-and-the-goblin-cover.avif" alt="" loading="lazy" aria-hidden="true">
              </div>
              <div class="book-info">
                <span class="book-title">The Princess and the Goblin</span>
                <span class="book-author">George MacDonald</span>
              </div>
            </button>
          </div>
          <p class="standard-ebooks-credit">
            Books provided by <a href="https://standardebooks.org" target="_blank" rel="noopener noreferrer">Standard Ebooks</a>
          </p>
        </section>
      </div>
    </div>
  </div>

  <!-- Error display (shown if app fails to load) -->
  <div id="error-display" class="hidden fixed inset-0 z-[9999] flex items-center justify-center bg-background p-4" role="alertdialog" aria-modal="true" aria-labelledby="error-title" aria-describedby="error-message">
    <div class="max-w-2xl w-full bg-card border border-destructive rounded-lg p-6 shadow-2xl">
      <h2 id="error-title" class="text-2xl font-bold text-destructive mb-4">Application Error</h2>
      <pre id="error-message" class="text-sm text-foreground bg-muted p-4 rounded overflow-auto max-h-[60vh] whitespace-pre-wrap font-mono"></pre>
      <div class="mt-4 flex gap-3">
        <button onclick="location.reload()" class="btn btn-primary">Reload Page</button>
        <button onclick="document.getElementById('error-display').classList.add('hidden')" class="btn btn-secondary">Dismiss</button>
      </div>
    </div>
  </div>

  <script>
    // Global error handler - displays errors on page
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error);
      const errorDisplay = document.getElementById('error-display');
      const errorMessage = document.getElementById('error-message');
      if (errorDisplay && errorMessage) {
        const errorText = event.error 
          ? `${event.error.name}: ${event.error.message}\n\n${event.error.stack || 'No stack trace'}`
          : `${event.message} at ${event.filename}:${event.lineno}:${event.colno}`;
        errorMessage.textContent = errorText;
        errorDisplay.classList.remove('hidden');
      }
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection:', event.reason);
      const errorDisplay = document.getElementById('error-display');
      const errorMessage = document.getElementById('error-message');
      if (errorDisplay && errorMessage) {
        const errorText = event.reason instanceof Error
          ? `Unhandled Promise Rejection: ${event.reason.name}: ${event.reason.message}\n\n${event.reason.stack || 'No stack trace'}`
          : `Unhandled Promise Rejection: ${String(event.reason)}`;
        errorMessage.textContent = errorText;
        errorDisplay.classList.remove('hidden');
      }
    });

    // Check if app loaded after 3 seconds
    setTimeout(() => {
      const app = document.getElementById('app');
      const uploadArea = document.getElementById('upload-area');
      const readerView = document.getElementById('reader-view');
      const errorDisplay = document.getElementById('error-display');
      
      // Only warn if nothing is visible (both upload and reader are hidden)
      // This indicates the app might be stuck
      if (app && 
          uploadArea && uploadArea.classList.contains('hidden') && 
          readerView && readerView.classList.contains('hidden') &&
          errorDisplay && errorDisplay.classList.contains('hidden')) {
        // No visible UI elements - app might not have initialized
        console.warn('App may not have initialized properly - no UI elements visible');
      }
    }, 3000);
  </script>

  <script type="module" src="/src/main.js"></script>
</body>
</html>
